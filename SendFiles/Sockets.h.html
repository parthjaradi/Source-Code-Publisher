<!DOCTYPE HTML>
<html>
  <head>
    <Title>Sockets.h</Title>
    <style>
     .comments {
     color: green }
      h3 {
        font-family: Cambria,Consolas;text-align: center;color: #f4602e;
      }
      h4 {
        font-family: Cambria,Consolas;
      }
      body {
        padding:0px 10px;
        font-family: Cambria,Consolas;
        font-size: 0.9375em;
        font-weight: normal;
      }
      .commentsBtn,.classBtn,.functionBtn {
      background-image: linear-gradient(to right, rgba(208, 212, 219,0), rgba(208, 212, 219,0.35));
      border: none;
      color: white;
      padding: 15px 32px;
      text - align: center;
      text - decoration: none;
      display: inline - block;
      margin: 4px 2px;
      cursor: pointer;
      }
      </style>
  <script src="myscripts.js"></script> 
  </head>

  <body>    <h3>Source Code File : Sockets.h<br/> </h3>
    <h4> Dependencies:       <a href="Logger.h.html">Logger.h</a>
      <a href="Utilities.h.html">Utilities.h</a>
      <a href="WindowsHelpers.h.html">WindowsHelpers.h</a>
    </h4><input type = "button" id = "commentsBtn" onclick = toggleComments() value = "Hide Comments"><input type = "button" id = "functionBtn" onclick = toggleFunctions() value = "Hide Functions"><input type = "button" id = "classBtn" onclick = toggleClasses() value = "Hide Classes">    <pre>
#ifndef SOCKETS_H
#define SOCKETS_H
<div class = "comments">////////////////////////////////////////////////////////////////////////</div><div class = "comments">/ Sockets.h - C++ wrapper for Win32 socket api                        //</div><div class = "comments">/ ver 5.2                                                             //</div><div class = "comments">/ Jim Fawcett, CSE687 - Object Oriented Design, Spring 2016           //</div><div class = "comments">/ CST 4-187, Syracuse University, 315 443-3948, jfawcett@twcny.rr.com //</div><div class = "comments">/---------------------------------------------------------------------//</div><div class = "comments">/ Jim Fawcett (c) copyright 2015                                      //</div><div class = "comments">/ All rights granted provided this copyright notice is retained       //</div><div class = "comments">/---------------------------------------------------------------------//</div><div class = "comments">/ Application: OOD Project #4                                         //</div><div class = "comments">/ Platform:    Visual Studio 2015, Dell XPS 8900, Windows 10 pro      //</div><div class = "comments">////////////////////////////////////////////////////////////////////////</div><div class = "comments">*
*  Package Operations:
*  -------------------
*  Provides four classes that wrap the Winsock API:
*  Socket:
*  - provides all the functionality necessary to handle server clients
*  - created by SocketListener after accepting a request
*  - usually passed to a client handling thread
*  SocketConnecter:
*  - adds the ability to connect to a server
*  SocketListener:
*  - adds the ability to listen for connections on a dedicated thread
*  - instances of this class are the only ones influenced by ipVer().
*    clients will use whatever protocol the server provides.
*  SocketSystem:
*  - Loads and unloads winsock2 library.  
*  - Declared once at beginning of execution
*
*  Required Files:
*  ---------------
*  Sockets.h, Sockets.cpp, 
*  Logger.h, Logger.cpp, 
*  Utilities.h, Utililties.cpp, 
*  WindowsHelpers.h, WindowsHelpers.cpp
*
*  Maintenance History:
*  --------------------
*  ver 5.2 : 05 Oct 2017
*  - changed Socket::recvString to append the terminating character, 
*    newline by default
*  - added removeTerminator method to remove the newly added terminator
*    character
*  - modified error logging displays
*  ver 5.1 : 10 Apr 16
*  - Added sendStream and recvStream to support sending and receiving
*    file streams.  These simply wrap the native sockets send and recv.
*  ver 5.0 : 04 Mar 16
*  - Fixed bugs in Socket test stub, essentially stealing fixes from
*    ClientTest.cpp and ServerTest.cpp
*  - Didn't change any code in the Socket library itself
*  ver 4.9 : 04 Mar 16
*  - Added a single write statement in Socket::Listener::accept()
*  ver 4.8 : 22 Feb 16
*  - Replaced verbose I/O with Logger I/O
*  - Replaced ApplicationHelpers package with Utilities package
*  ver 4.7 : 04 Apr 15
*  - removed testBlockHandling declaration from Socket.cpp ClientHandler.
*    The implementation had already been removed, I just forgot the declaration.
*  - added test for INVALID_SOCKET in Socket::recvString.  The omission was
*    reported by Huanming Fang.  Thanks Huanming.
*  ver 4.6 : 30 Mar 15
*  - minor modification to comments, above, and in Socket class implem.
*  ver 4.5 : 30 Mar 15
*  - moved SocketListener::start(...) from cpp to h file since it is a
*    template method.
*  - renamed ClientProc to ClientHandler
*  - removed Block operations to avoid binding Socket package to
*    FileSystem package.  Will add buffer operations to the
*    FileSystem::File class to match the Socket buffer operations.
*  - gave ClientHandler a command interpreter to select a test process
*    - test string tranfers
*    - test buffer transfers
*    - client sends a string to select test mode
*    - test modes are (string, buffer, and stop)
*  - Created a Verbose class in AppHelpers package that locks stream io.
*    That helps to keep server and client io text from intermingling.
*    You can turn verbose mode off which silences output that isn't
*    marked "always".
*  - Fixed again the bug which prevented communicating with anything other
*    than the loopback by adding hints.ai_flags = AI_PASSIVE to
*    SocketListener member data.
*  - added more testing
*  ver 4.4 : 27 Mar 15
*  - minor changes to comments
*  - moved ClientHandler into test stub
*  ver 4.3 : 26 Mar 15
*  - fixed bug noticed by Tarun Rajput 
*  - used '0' as terminator.  Should have been '\0'
*  ver 4.2 : 26 Mar 15
*  - several small changes to the Socket class interface
*  ver 4.1 : 25 Mar 15
*  - fixed connection bug that prevented connecting to anything
*    other than a loopback (localhost, 127.0.0.1, ::1) by
*    adding winsock code to SocketConnecter().
*  - removed low-level code from ClientProc 
*    (server's client handler callable object)
*    replaced with code written to Socket interface
*  Ver 4.0 : 24 Mar 15
*  - first release of total redesign - had a known bug (see ver 4.1)
*/</div>
<div class = "comments">*
* ToDo:
* - make SocketSystem a reference counted instance of Socket
* - write buffered recv which efficiently returns string or line
*   - reads and concatenates everything available into circular buffer
*   - parses out first string or line and moves start of buffer pointer
*     to begining of next
* -----------------------------------------------------------------------
*  Wait for The next items until Students have submitted their code
* -----------------------------------------------------------------------
* - build front end, e.g., Sender and Receiver classes
* - implement message facility: message class, sendMsg and recvMsg
* - Test and Display packages
*/</div>

#ifndef WIN32_LEAN_AND_MEAN  <div class = "comments">/ prevents duplicate includes of core parts of windows.h in winsock2.h</div>#define WIN32_LEAN_AND_MEAN
#endif

#include &lt;Windows.h&gt;      <div class = "comments">/ Windnows API</div>#include &lt;winsock2.h&gt;     <div class = "comments">/ Windows sockets, ver 2</div>#include &lt;WS2tcpip.h&gt;     <div class = "comments">/ support for IPv6 and other things</div>#include &lt;IPHlpApi.h&gt;     <div class = "comments">/ ip helpers</div>
#include &lt;vector&gt;
#include &lt;string&gt;
#include &lt;atomic&gt;

#include "../WindowsHelpers/WindowsHelpers.h"
#include "../Utilities/Utilities.h"
#include "../Logger/Logger.h"

#pragma warning(disable:4522)
#pragma comment(lib, "Ws2_32.lib")

namespace Sockets
<div class=namespace id=141>{
  <div class = "comments">////////////////////////////////////////////////////////////////////////////</div>  <div class = "comments">/ SocketSystem class - manages loading and unloading Winsock library</div>
  class SocketSystem
  <div class=cclass id=146>{
  public:
    SocketSystem();
    ~SocketSystem();
  private:
    int iResult;
    WSADATA wsaData;
  };
</div>
  <div class = "comments">////////////////////////////////////////////////////////////////////////////</div>  <div class = "comments">/ Socket class</div>  <div class = "comments">/ - used by server for client handling</div>  <div class = "comments">/ - base for SocketConnecter and SocketListener classes</div>
  class Socket
  <div class=cclass id=161>{
  public:
    enum IpVer <div class=anonymous id=163>{ IP4, IP6 };</div>
    using byte = char;

    <div class = "comments">/ disable copy construction and assignment</div>    Socket(const Socket& s) = delete;
    Socket& operator=(const Socket& s) = delete;

    Socket(IpVer ipver = IP4);
    Socket(::SOCKET);
    Socket(Socket&& s);
    operator ::SOCKET() <div class=function id=173>{ return socket_; }</div>
    Socket& operator=(Socket&& s);
    virtual ~Socket();

    IpVer& ipVer();
    bool send(size_t bytes, byte* buffer);
    bool recv(size_t bytes, byte* buffer);
    size_t sendStream(size_t bytes, byte* buffer);
    size_t recvStream(size_t bytes, byte* buffer);
    bool sendString(const std::string& str, byte terminator = '\0');
    std::string recvString(byte terminator = '\0');
    static std::string removeTerminator(const std::string& src);
    size_t bytesWaiting();
    bool waitForData(size_t timeToWait, size_t timeToCheck);
    bool shutDownSend();
    bool shutDownRecv();
    bool shutDown();
    void close();

    bool validState() <div class=function id=192>{ return socket_ != INVALID_SOCKET; }</div>

  protected:
    WSADATA wsaData;
    ::SOCKET socket_;
    struct addrinfo *result = NULL, *ptr = NULL, hints;
    int iResult;
    IpVer ipver_ = IP4;
  };
</div>
  <div class = "comments">////////////////////////////////////////////////////////////////////////////</div>  <div class = "comments">/ SocketConnecter class</div>  <div class = "comments">/ - supports connecting to a SocketListener</div>
  class SocketConnecter : public Socket
  <div class=cclass id=207>{
  public:
    SocketConnecter(const SocketConnecter& s) = delete;
    SocketConnecter& operator=(const SocketConnecter& s) = delete;

    SocketConnecter();
    SocketConnecter(SocketConnecter&& s);
    SocketConnecter& operator=(SocketConnecter&& s);
    virtual ~SocketConnecter();

    bool connect(const std::string& ip, size_t port);
  };
</div>
  <div class = "comments">////////////////////////////////////////////////////////////////////////////</div>  <div class = "comments">/ SocketListener class</div>  <div class = "comments">/ - listens for incoming connections</div>  <div class = "comments">/ - each connection is handled on its own thread</div>
  class SocketListener : public Socket
  <div class=cclass id=226>{
  public:
    SocketListener(const SocketListener& s) = delete;
    SocketListener& operator=(const SocketListener& s) = delete;

    SocketListener(size_t port, IpVer ipv = IP6);
    SocketListener(SocketListener&& s);
    SocketListener& operator=(SocketListener&& s);
    virtual ~SocketListener();

    template&lt;typename CallObj&gt;
    bool start(CallObj& co);
    void stop();
  private:
    bool bind();
    bool listen();
    Socket accept();
    std::atomic&lt;bool&gt; stop_ = false;
    size_t port_;
    bool acceptFailed_ = false;
  };
</div>
  <div class = "comments">/----&lt; SocketListener start function runs listener on its own thread &gt;------</div>  <div class = "comments">*
  *  - Accepts Callable Object that defines the operations
  *    to handle client requests.
  *  - You will find an example Callable Object, ClientProc,
  *    used in the test stub below
  */</div>
  template&lt;typename CallObj&gt;
  bool SocketListener::start(CallObj& co)
  <div class=function id=257>{
    if (!bind())
    <div class=control id=259>{
      return false;
    }</div>

    if (!listen())
    <div class=control id=264>{
      return false;
    }</div>
    <div class = "comments">/ listen on a dedicated thread so server's main thread won't block</div>
    std::thread ListenThread(
      [&]()
    <div class=anonymous id=271>{
      StaticLogger&lt;1&gt;::write("\n  -- server waiting for connection");

      while (!acceptFailed_)
      <div class=control id=275>{
        if (stop_.load())
          break;

        <div class = "comments">/ Accept a client socket - blocking call</div>
        Socket clientSocket = accept();    <div class = "comments">/ uses move ctor</div>        if (!clientSocket.validState()) <div class=control id=282>{
          continue;
        }</div>
        StaticLogger&lt;1&gt;::write("\n  -- server accepted connection");

        <div class = "comments">/ start thread to handle client request</div>
        <div class = "comments">/std::thread clientThread(std::ref(co), std::move(clientSocket));</div>        std::thread clientThread(co, std::move(clientSocket));
        clientThread.detach();  <div class = "comments">/ detach - listener won't access thread again</div>      }</div>
      StaticLogger&lt;1&gt;::write("\n  -- Listen thread stopping");
    }</div>
    );
    ListenThread.detach();
    return true;
  }</div>
}</div>
#endif

    </pre>
  </body>
</html>
